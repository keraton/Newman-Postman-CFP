This how we will present Postman & Newman
-----------------------------------------

- PPT (5 min - 7 min)
  - Introduction : BB
    - Hello welcome to our talk session, Postman & Newman for your CICD
  - Polling : BB + XT
    - We are going to start with a pooling session, please go to the this address and fill the form.
    - I know that Postman is sound a bit boring, because it has been around like forever, something that old, but now we have a new..man, which really interesting because it is a new .. man
  - Result Polling Result : BB
  - Postman : BB
    - Postman is not only an API Testing Tools, but now it is also a company.
    - It deals with everything that related to API, such as testing, design, monitoring, mocking, collaborative working ..
    - So if you are interested with that, you can go to their website here,
    - They are building also a community. you can check it here, it has a lot of request such as new features, bug fix etc.
  - Newman 
    - XT
      - So, We will talk about Newman, a command line tool to run your Postman collections from a terminal. It is an open-source project with an active community, already in V4 and also an npm library easy to download and use in any NodeJS code.
  - Who we are : BB -> XT (.. and I am Xavier Thery, also a Software developer engineer at Egencia. You can add me on tweeter as well but I don't post often)
  - Egencia : BB
  - Use case : BB -> XT  (Ahah.. sure, we will do it anyway)
- Demo 
  - BB
    - Xavier please show us about the flight-service application that we have been build
  - XT  
    - Sure our flight-service application has two main APIs: search and booking. Search works like this, given an origin like Paris CDG airport, a destination Toulouse TLS and a departure time, let's see in one month from now 05/12/2019. We get all available flights. we take one AF001 and we have details about its pricing with the following call /price/AF001. As for the booking, I will need some other tool in order to make a POST request, we could use cURL but of course we will use Postman.
    - With Postman, you can create collections that contain your queries. **(start doing that ??)**
 - BB
    -  But it is painfull to write all those queries manually even thought our sample API is quite small.
 - XT    
    - You can now easily generate your OpenAPI specification or swagger from your API and vice-versa. Let's do this, we exposed our specification, we can copy it and import it in Postman. Now you have all your queries pre-generated.
    - We need to declare some environment variables, for baseURL already defined by Swagger, but it can be done for any parameter, for origin for example. This way we can easily change them for all our queries depending on your test environment. Either localhost, alpha, beta or prod.
    - Oh! Let's add some authentication, it can be done per queries or directly in the collection so every queries can inherit this behavior. 
    - Now testing the same search, same request on pricing. And for booking we need to complete this prefilled body with the selected pricing. As booking is asynchronous, we also have a call to poll the booking status.
  - BB
    - This look goods but, we need to run it one by one, can we just run the collection ?
  - XT  
    - Sure I got prepared for this talk ;). Let's have a look at this collection where I copied all our calls: search, pricing, booking and get booking status
    - I added a prescript, some Javascript executed before the request, in order to set a dynamic departure time. We use some postman APIs provided in order to do so, pm.setEnvironment
    - And also a test, some Javascript executed after the request, in order to set some parameters for the next request, here the flight number. We are also doing some asertions, response ok, 7 flights in response, in order to automate our tests. You can see that we are also using some postman APIs and they include ChaiJS library in order to perform assertion, pm.expect.
    - Running the collection, .. and it is failing because we are quite too fast I guess.
  - BB  
    - This because the booking is asynchrone, and the getBooking query is to early
  - XT  
    - Not a big deal, let's add some delay on our run. 4 seconds for example.
    - Rerun the test. Now we wait 4 seconds between each query.
  - BB  
    - This is working now, but why do we need to put delay to all request, we only need delay between booking & getBooking
  - XT  
    - Ok Sure. Actually Postman provides some usefull endpoints. One we could be interested in is the delay. Here it will wait for 3 seconds until responding. Now let's copy it in our collection between the booking and the booking status with 5 seconds delay. Running the collection again.
  - BB  
    - Those endpoints are called a Postman echo : Postman Echo is service you can use to test your REST clients and make sample API calls. It provides endpoints for GET, POST, PUT, various auth mechanisms and other utility endpoints.
    - It is better but the delay is FIXED is not ideal, the booking could be very fast or very slow
  - XT  
    - I agree with you, a fixed delay is not ideal to run some automated tests. As I said, prerequest scripts and tests contain Javascript, so we can write some code to solve our issue.
    - Using Javascript setTimeout and Postman.setNextRequest, we create the loop we need in order to wait for our booking to be successful. Let's try it.
  - BB  
    - This way better, but this still manual in the sense, developper, tester need to run it from their computer
  - XT  
    - This is the time we introduce Newman
    - Exporting our collection and environment as json **(Need to show the json file of both collection & env)**
    - Now running the same collection within a terminal with Newman CLI previously installed with npm. We get same result, but it is now much easier to reuse our collections anywhere.    
  - BB  
    - But I don't this is the end, we need to automatise this
  - XT
    - Of course the idea is to add Newman to our CICD in order to have automated end to end test
    - Here we use Jenkins with a Jenkinsfile. Our pipeline has few stages: build, package, test and deploy. Test is where we will execute Newman using npm and a package json file.
    - See, in this package.json we added Newman dependency and we wrote the same command line from the terminal. Adding some reporters in order to save the result in a format that Jenkins can understand: HTML or junit
    - Modifying application version just to relaunch our pipeline with a commit hook we put for the demonstration.
    - As you can see, we have our 4 stages: build, package, test and deploy. It takes a while but you can already some junit results and HTML published from previous run. I will show you again this run in a moment.
  - BB  
    - This is very cool, now we have the pipeline & regression test
    - But you know, this is a very new app, we don't have many users, I would like to know if it is available all the time
    - Can we can use this test for monitoring ?        
  - XT  
    - Sure, since Newman is a npm library we can write any Javascript, NodeJS code and run it as serverless functions for example as it fit very well monitoring purpose. We chose AWS Lambda and the function can be triggered by a schedule or any event in some AWS ressources. 
    - We decided to use Serverless framework to deploy our function with a schedule that will trigger Newman every 1 minutes.
    - In the code we import Newman, using it is then quite similar to the command line: newman.run plus options containing our collection and environment.
  - BB  
    - This is quite good but I don't want to look at the log all the time, I want to be alerted
  - XT 
    - We also added a slack webhook, see this snippet will send the result to our slack channel. Now we can be aware of any issue arising.
    - During this talk our scheduled function was fired a few time as you can see, running Newman against our production application.
 - PPT
  - What we have seen : 
     - BB
        - Proper test
        - Not only test but also REST design, 
        - No it start to support GraphQL
  - Pros & Cons 
    - XT 
      - From our personal usage the pros are that we can easily use the collections we were already using within our team to perform some acceptance tests. The learning curve is small if you already know how to use Postman and Newman CLI is quite straightforward. So no new language to learn, writing your first end to end test will be quick. Community support is big, for example you can find reporters for a lot of languages.
      - Some minor cons. It is not possible to run multiple collections with one Newman run. Indeed we wanted to have a separate collection for each of our scenarios. In order to do that you will need multiple Newman command, wrap everything in a loop or perhaps contribute to the project. Credentials are not handled by either Postman or Newman so you will need a third party service to avoid delivering usernames/passwords.
  - Rate us : BB & XT
      
## TO ADD if we have a time before conclusion
- Show https://www.npmtrends.com/newman (for two years)
- 
